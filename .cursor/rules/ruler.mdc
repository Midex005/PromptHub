---
alwaysApply: true
---

---

alwaysApply: true

---

  

# AI 编程规则

  

> **说明**：本规则定义 AI 在项目中进行代码生成、修改、阅读、调试与审查时的强制行为规范。

> 所有条目均为强制执行规则，不得被覆盖或忽略。

  

---

  

## 目录

  

1. [代码提交规则](#1-代码提交规则submission-policy)

2. [文档管理规则](#2-文档管理规则documentation-policy)

3. [代码质量保证](#3-代码质量保证code-quality-assurance)

4. [BUG 修复原则](#4-bug-修复原则bug-fix--root-cause)

5. [修改完整性要求](#5-修改完整性要求comprehensive-change-policy)

6. [禁止的实现方式](#6-禁止的实现方式forbidden-implementations)

7. [代码阅读与理解](#7-代码阅读与理解code-comprehension)

8. [工作流程规范](#8-工作流程规范workflow-steps)

9. [知识补全机制](#9-知识补全机制knowledge-retrieval-policy)

10. [白盒代码审计](#10-白盒代码审计white-box-audit)

11. [模型自检流程](#11-模型自检流程ai-self-validation-checklist)

12. [行为守则](#12-行为守则ethical-principles)

  

---

  

## 1. 代码提交规则（Submission Policy）

  

1. **禁止自动提交或推送代码**

- 严禁执行 `git commit`、`git push`、`git merge` 等操作。

- 仅当用户明确下达提交指令（如 "提交代码"、"commit" 等）时，方可执行。

2. **需人工确认后方可提交**

- 所有更改必须经用户确认；

- 模型不得擅自判断"代码可提交"或"修改已完成"。

  

---

  

## 2. 文档管理规则（Documentation Policy）

  

1. **禁止随意创建文档**

- 严禁未经用户明确允许擅自创建文档文件；

- 仅当用户明确要求"写文档"、"创建文档"、"生成文档"等指令时，方可创建。

  

2. **文档存放位置强制规范**

- **所有文档必须放置在 `docs/` 目录下**；

- 禁止在项目根目录或代码目录中创建 `.md` 文档文件；

- 临时性的开发笔记、TODO、审计报告等文档也必须放入 `docs/` 对应子目录。

  

3. **文档目录结构规范**

```

docs/

├── README.md # 文档索引

├── architecture/ # 架构设计文档

├── api/ # API接口文档

├── services/ # 各服务模块文档

│ ├── grant-writing/

│ ├── literature-analysis/

│ └── thesis-writing/

├── development/ # 开发指南文档

├── guides/ # 使用指南文档

└── operations/ # 运维相关文档

```

  

4. **文档命名规范**

- 使用小写字母和连字符：`api-documentation.md`（英文）或 `系统架构.md`（中文）；

- 避免使用空格、特殊字符；

- 文档名应准确反映内容主题。

  

5. **禁止的文档行为**

- ❌ 在项目根目录创建 `CLAUDE.md`、`README_TEMP.md` 等临时文档；

- ❌ 在代码目录（如 `backend/`、`services/`）中创建审计报告、设计文档；

- ❌ 创建与现有文档重复的内容；

- ❌ 创建空文档或仅包含 TODO 的文档。

  

6. **正确的文档创建流程**

- 用户明确要求创建文档；

- 确定文档类型和主题；

- 在 `docs/` 对应子目录中创建文档；

- 更新 `docs/README.md` 索引（如果需要）；

- 确保文档内容完整、格式规范。

  

---

  

## 3. 代码质量保证（Code Quality Assurance）

  

### 3.1 静态审查

- 编写完成后必须运行 Linter（如 `read_lints`）；

- 检查并修复语法错误、类型错误、未定义变量；

- 验证 import 语句与路径有效；

- 清理冗余代码、无用 import、重复定义。

  

### 3.2 风格一致性

- **Python**：遵循 PEP8 标准，必须添加类型注解；

- **TypeScript / Vue**：遵循 ESLint 规范，使用 `interface` 定义类型；

- **Java**：遵循项目统一命名规范、缩进风格（4 空格），注释必须完整；

- 保持命名风格、缩进与项目一致；

- 输出前自动格式化代码，保证一致性。

  

---

  

## 4. BUG 修复原则（Bug Fix & Root Cause）

  

1. **必须修复根本原因**，禁止以下行为：

- 降级处理（使用旧版 API 替代新版本）；

- 盲目捕获异常（如 `try-except-pass` 或空 `catch`）；

- 注释出错代码；

- 临时补丁或假修复。

  

2. **正确修复步骤：**

- 追踪调用栈，定位真实根因；

- 阅读相关模块与逻辑；

- 修复源头问题，而非掩盖症状；

- 确认修改不破坏其他功能；

- 必要时添加测试用例或更新单元测试。

  

---

  

## 5. 修改完整性要求（Comprehensive Change Policy）

  

1. **若修改任何功能或逻辑，必须完整同步修改相关文件：**

- 业务逻辑代码；

- 数据层文件（Mapper / DAO / Repository）；

- 数据库脚本（SQL / Migration）；

- 配置文件（XML / YAML / JSON）；

- API 接口定义、DTO、实体类；

- 单元测试及集成测试。

  

2. **Java 项目特别要求：**

- 若修改 Java 代码中与数据库相关的部分，必须同时：

- 更新对应的 Mapper 文件；

- 修改或同步 XML 配置；

- 更新 SQL 脚本（如表结构或字段变化）；

- 调整关联实体类与 VO / DTO；

- 验证调用关系是否保持一致；

- 若接口变更，更新对应 Service 与 Controller 层。

  

3. **修改时必须追踪所有依赖与调用链：**

- 使用 `grep` 或全局搜索定位被调用位置；

- 检查参数类型与返回值一致性；

- 确认修改不引发连锁错误；

- 更新文档或注释，确保团队成员能理解修改意图。

  

---

  

## 6. 禁止的实现方式（Forbidden Implementations）

  

严禁以下行为：

  

- 使用 Mock 数据或假接口；

- 使用占位符 / TODO 代码；

- 简化逻辑、跳过必要步骤；

- 伪造调用或虚拟执行。

  

**正确做法：**

- 实现完整、真实的业务逻辑；

- 确保连接数据库、外部 API 或实际服务；

- 符合既有架构设计；

- 经单元测试和集成测试验证后方可提交。

  

---

  

## 7. 代码阅读与理解（Code Comprehension）

  

1. **阅读原则**

- 使用 `read_file` 查看完整函数实现；

- 不得凭记忆或猜测类型；

- 追踪 import、调用链与依赖关系；

- 理解每个函数的输入输出与副作用。

  

2. **修改前理解**

- 弄清功能逻辑、数据流、状态管理；

- 掌握错误处理机制与配置；

- 阅读上下文环境（变量、常量、依赖模块）。

  

3. **修改时审慎**

- 检查是否影响其他模块；

- 保持接口参数与类型兼容；

- 考虑边界与异常场景；

- 不确定时先询问用户确认。

  

---

  

## 8. 工作流程规范（Workflow Steps）

  

1. **接收任务** → 明确目标与需求。

2. **调研代码** → 阅读相关模块与依赖。

3. **设计方案** → 制定完整修改计划，不走捷径。

4. **实现代码** → 严格遵守规范与风格。

5. **审查质量** → 运行 Linter，检查错误与警告。

6. **同步修改** → 更新 SQL / Mapper / 配置 / 测试 等相关部分。

7. **等待确认** → 未获许可前不得提交。

  

---

  

## 9. 知识补全机制（Knowledge Retrieval Policy）

  

1. **当知识库中无相关信息时：**

- 首先调用 **context7 MCP 服务** 获取项目上下文知识；

- 若仍无结果，则自动执行网页搜索，查找可靠来源；

- 对外部信息需进行合理验证，确保内容准确；

- 不得引用不确定或未经验证的信息。

  

2. **补全逻辑**

- 优先使用项目内部知识；

- 若依赖外部信息，需在输出中标注信息来源；

- 若仍不确定，应提示用户“需要更多信息或确认”。

  

---

  

## 10. 白盒代码审计（White-Box Audit）

  

当用户要求"白盒审计"或"代码审查"时，必须执行以下全面检查：

  

### 10.1 安全性审计（Security）

  

1. **认证与授权**

- 检查是否缺少权限验证

- 检查是否存在越权访问（IDOR）

- 验证 API 密钥、token 的安全存储

  

2. **输入验证**

- 检查所有用户输入是否经过验证

- 检查是否存在 SQL 注入、XSS、命令注入风险

- 验证文件上传的类型、大小、内容检查

  

3. **敏感信息泄露**

- 检查日志中是否记录敏感信息（密码、密钥、token）

- 检查错误信息是否暴露内部实现细节

- 验证响应中是否包含不必要的调试信息

  

### 10.2 逻辑健壮性审计（Robustness）

  

1. **异常处理**

- 检查是否存在空指针/None引用

- 检查是否存在未捕获的异常

- 验证异常处理是否完整（不使用空 catch/pass）

- 检查是否所有异常都有日志记录（`exc_info=True`）

  

2. **边界条件**

- 检查空值、空列表、空字典的处理

- 检查数组越界、除零、溢出等风险

- 验证循环终止条件

  

3. **资源管理**

- 检查文件句柄、数据库连接、网络连接是否正确关闭

- 检查是否存在内存泄漏（未释放的大对象）

- 验证临时文件是否清理

  

4. **并发安全**

- 检查共享状态的线程安全

- 检查是否存在死锁、竞态条件

- 验证异步操作的错误处理

  

### 10.3 性能审计（Performance）

  

1. **算法复杂度**

- 检查是否存在 O(n²) 或更高复杂度的嵌套循环

- 检查是否可以使用字典/集合优化查找

- 验证数据库查询是否存在 N+1 问题

  

2. **资源消耗**

- 检查是否存在不必要的重复计算

- 检查是否缓存可复用的结果

- 验证大文件、大数据集的处理是否分批

  

3. **I/O 优化**

- 检查是否存在频繁的小文件读写

- 检查网络请求是否可以批量处理

- 验证数据库查询是否使用索引

  
  

2. **日志级别正确性**

- `DEBUG`: 调试信息（如变量值、中间状态）

- `INFO`: 关键步骤完成（如"已下载文件"、"已生成摘要"）

- `WARNING`: 可恢复的异常情况（如"API 重试"、"使用默认值"）

- `ERROR`: 错误但不影响主流程（如"某个文件处理失败"）

- `CRITICAL`: 致命错误（如"数据库连接失败"）

  

3. **日志内容完整性**

- 任务开始：记录所有输入参数、配置

- 关键步骤：记录进度、状态、耗时

- 异常情况：必须包含完整堆栈（`exc_info=True`）

- 任务结束：记录结果统计、耗时

  

4. **日志结构化**

- 使用统一的日志格式：`时间 [级别] 消息`

- 关键操作使用分隔线标记：`========== 步骤X ==========`

- 包含上下文信息：`[文件名] [任务ID] 消息`

  

### 10.4 代码风格审计（Code Style）

  

1. **命名规范**

- Python: `snake_case` for 函数/变量, `PascalCase` for 类

- TypeScript: `camelCase` for 函数/变量, `PascalCase` for 类/接口

- 常量: 全大写 `UPPER_SNAKE_CASE`

- 私有变量/函数: 单下划线前缀 `_private`

  

2. **类型注解**

- Python: 所有函数必须有参数和返回值类型注解

- TypeScript: 使用 `interface` 定义复杂类型，禁用 `any`

  

3. **文档字符串**

- 所有 public 函数必须有 docstring

- docstring 必须包含：功能描述、参数说明、返回值说明、异常说明

- 使用 Google 风格或 NumPy 风格

  

4. **代码组织**

- 单个函数不超过 50 行（复杂业务逻辑可例外）

- 单个文件不超过 500 行

- 相关功能放在同一个模块

  

### 10.5 降级处理审计（No Fallback Policy）

  

**严格禁止**以下降级行为：

  

1. **使用默认值掩盖错误**

```python

# ❌ 错误

value = data.get("key", "default")

# ✅ 正确

if "key" not in data:

raise ValueError("缺少必需字段: key")

value = data["key"]

```

  

2. **捕获异常后返回空值**

```python

# ❌ 错误

try:

result = risky_operation()

except Exception:

return None

# ✅ 正确

try:

result = risky_operation()

except SpecificException as e:

logger.error(f"操作失败: {e}", exc_info=True)

raise RuntimeError("操作失败") from e

```

  

3. **使用旧版API替代新版**

```python

# ❌ 错误

try:

new_api_call()

except:

old_api_call() # 降级到旧API

# ✅ 正确

new_api_call() # 直接使用新API，失败则抛出异常

```

  

4. **占位符/TODO代码**

```python

# ❌ 错误

def complex_logic():

# TODO: 实现复杂逻辑

return {}

# ✅ 正确

def complex_logic():

# 实现完整的业务逻辑

...

```

  

### 10.6 审计报告格式

  

审计完成后，必须输出结构化报告：

  

```markdown

## 白盒审计报告

  

### 🔴 严重问题（必须修复）

1. **[问题类别]** 问题描述

- 位置: `file.py:123`

- 影响: 具体影响

- 解决方案: 如何修复

  

### 🟡 中等问题（建议修复）

...

  

### 🟢 轻微问题（可选修复）

...

  

### ✅ 通过检查

...

```

  

---

  

## 11. 模型自检流程（AI Self-Validation Checklist）

  

在每次输出代码或修改后，AI 必须自查以下项目：

  

### 11.1 基础检查

1. ✅ 是否违反提交规则

2. ✅ 是否运行过 Linter 并通过

3. ✅ 是否符合代码风格

4. ✅ 是否已同步修改 SQL / Mapper / 配置 / 测试等相关文件

  

### 11.2 质量检查

5. ✅ 是否阅读并理解相关逻辑

6. ✅ 是否真正修复根因（非降级处理）

7. ✅ 是否所有异常都有完整处理（`exc_info=True`）

8. ✅ 是否添加了必要的类型注解

  

### 11.3 安全检查

9. ✅ 是否验证了所有用户输入

10. ✅ 是否存在敏感信息泄露

11. ✅ 是否正确处理了权限验证

  

### 11.4 日志检查

12. ✅ 是否为任务创建了独立日志（`TaskLoggerManager`）

13. ✅ 是否在关键步骤记录了日志

14. ✅ 是否日志会上传到 MinIO

  

### 11.5 知识补全

15. ✅ 是否调用过 context7 MCP 或网页搜索补全知识

16. ✅ 是否需要用户确认

  

### 11.6 文档管理检查

17. ✅ 是否未经允许创建了文档

18. ✅ 创建的文档是否放置在 `docs/` 目录下

19. ✅ 是否在代码目录或项目根目录创建了文档文件

  

---

  

## 12. 行为守则（Ethical Principles）

  

- 用户信任高于一切；未经许可的提交为严重违规。

- 质量优先于速度；拒绝“快速但草率”的行为。

- 沟通优先于假设；任何不确定都必须询问用户。

- 修改必须完整；局部修改而未更新关联模块视为错误。

- 做正确的事，而不是最快的事。